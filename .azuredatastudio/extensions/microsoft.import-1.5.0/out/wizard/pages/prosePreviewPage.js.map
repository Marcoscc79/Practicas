{"version":3,"file":"prosePreviewPage.js","sourceRoot":"../../../src","sources":["wizard/pages/prosePreviewPage.ts"],"names":[],"mappings":"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","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the Source EULA. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\nimport * as azdata from 'azdata';\nimport { ImportPage } from '../api/importPage';\nimport * as constants from '../../common/constants';\nimport { DerivedColumnDialog } from '../../dialogs/derivedColumnDialog';\nimport * as vscode from 'vscode';\n\nexport class ProsePreviewPage extends ImportPage {\n\n\tprivate _table: azdata.TableComponent;\n\tprivate _loading: azdata.LoadingComponent;\n\tprivate _form: azdata.FormContainer;\n\tprivate _resultTextComponent: azdata.TextComponent;\n\tprivate _isSuccess: boolean;\n\n\tpublic get table(): azdata.TableComponent {\n\t\treturn this._table;\n\t}\n\n\tpublic set table(table: azdata.TableComponent) {\n\t\tthis._table = table;\n\t}\n\n\tpublic get loading(): azdata.LoadingComponent {\n\t\treturn this._loading;\n\t}\n\n\tpublic set loading(loading: azdata.LoadingComponent) {\n\t\tthis._loading = loading;\n\t}\n\n\tpublic get form(): azdata.FormContainer {\n\t\treturn this._form;\n\t}\n\n\tpublic set form(form: azdata.FormContainer) {\n\t\tthis._form = form;\n\t}\n\n\tpublic get resultTextComponent(): azdata.TextComponent {\n\t\treturn this._resultTextComponent;\n\t}\n\n\tpublic set resultTextComponent(resultTextComponent: azdata.TextComponent) {\n\t\tthis._resultTextComponent = resultTextComponent;\n\t}\n\n\tpublic get isSuccess(): boolean {\n\t\treturn this._isSuccess;\n\t}\n\n\tpublic set isSuccess(isSuccess: boolean) {\n\t\tthis._isSuccess = isSuccess;\n\t}\n\n\tasync start(): Promise<boolean> {\n\t\tthis.table = this.view.modelBuilder.table().withProps({\n\t\t\tdata: undefined,\n\t\t\tcolumns: undefined,\n\t\t\tforceFitColumns: azdata.ColumnSizingMode.DataFit\n\t\t}).component();\n\n\t\tthis.instance.createDerivedColumnButton.onClick(async (e) => {\n\t\t\tconst derivedColumnDialog = new DerivedColumnDialog(this.model, this.provider);\n\t\t\tconst response = await derivedColumnDialog.createDerivedColumn();\n\t\t\tif (response) {\n\t\t\t\tthis.model.proseColumns.push({\n\t\t\t\t\tcolumnName: response.derivedColumnName,\n\t\t\t\t\tdataType: 'nvarchar(MAX)',\n\t\t\t\t\tprimaryKey: false,\n\t\t\t\t\tnullable: true\n\t\t\t\t});\n\t\t\t\tresponse.derivedColumnDataPreview.forEach((v, i) => {\n\t\t\t\t\tthis.model.proseDataPreview[i].push(v);\n\t\t\t\t});\n\t\t\t\tthis.populateTable(this.model.proseDataPreview, this.model.proseColumns.map(c => c.columnName));\n\t\t\t}\n\t\t});\n\n\t\tthis.loading = this.view.modelBuilder.loadingComponent().component();\n\n\t\tthis.resultTextComponent = this.view.modelBuilder.text()\n\t\t\t.withProps({\n\t\t\t\tvalue: this.isSuccess ? constants.successTitleText : constants.failureTitleText\n\t\t\t}).component();\n\n\t\tthis.form = this.view.modelBuilder.formContainer().withFormItems([\n\t\t\t{\n\t\t\t\tcomponent: this.resultTextComponent,\n\t\t\t\ttitle: ''\n\t\t\t},\n\t\t\t{\n\t\t\t\tcomponent: this.table,\n\t\t\t\ttitle: ''\n\t\t\t}\n\n\t\t]).component();\n\n\t\tthis.loading.component = this.form;\n\n\t\tawait this.view.initializeModel(this.loading);\n\n\t\treturn true;\n\t}\n\n\tasync onPageEnter(): Promise<boolean> {\n\t\tlet proseResult: boolean;\n\t\tlet error: string;\n\t\tconst enablePreviewFeatures = vscode.workspace.getConfiguration('workbench').get('enablePreviewFeatures');\n\t\tif (this.model.newFileSelected) {\n\t\t\tthis.loading.loading = true;\n\t\t\ttry {\n\t\t\t\tproseResult = await this.learnFile();\n\t\t\t} catch (ex) {\n\t\t\t\terror = ex.toString();\n\t\t\t\tthis.instance.wizard.message = {\n\t\t\t\t\tlevel: azdata.window.MessageLevel.Error,\n\t\t\t\t\ttext: error\n\t\t\t\t};\n\t\t\t}\n\t\t\tthis.model.newFileSelected = false;\n\t\t\tthis.loading.loading = false;\n\t\t}\n\t\tif (!this.model.newFileSelected || proseResult) {\n\t\t\tawait this.populateTable(this.model.proseDataPreview, this.model.proseColumns.map(c => c.columnName));\n\t\t\tthis.isSuccess = true;\n\t\t\tif (this.form) {\n\t\t\t\tthis.resultTextComponent.value = constants.successTitleText;\n\t\t\t}\n\t\t\tthis.instance.createDerivedColumnButton.hidden = !enablePreviewFeatures;\n\t\t\treturn true;\n\t\t} else {\n\t\t\tawait this.populateTable([], []);\n\t\t\tthis.isSuccess = false;\n\t\t\tif (this.form) {\n\t\t\t\tthis.resultTextComponent.value = constants.failureTitleText + '\\n' + (error ?? '');\n\t\t\t}\n\t\t\treturn false;\n\t\t}\n\t}\n\n\toverride async onPageLeave(): Promise<boolean> {\n\t\tthis.instance.createDerivedColumnButton.hidden = true;\n\t\treturn true;\n\t}\n\n\toverride async cleanup(): Promise<boolean> {\n\t\tdelete this.model.proseDataPreview;\n\t\treturn true;\n\t}\n\n\tpublic override setupNavigationValidator() {\n\t\tthis.instance.registerNavigationValidator((info) => {\n\t\t\tif (info) {\n\t\t\t\t// Prose Preview to Modify Columns\n\t\t\t\tif (info.lastPage === 1 && info.newPage === 2) {\n\t\t\t\t\treturn this.table.data && this.table.data.length > 0;\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn !this.loading.loading;\n\t\t});\n\t}\n\n\tprivate async learnFile(): Promise<boolean> {\n\t\tconst response = await this.provider.sendPROSEDiscoveryRequest({\n\t\t\tfilePath: this.model.filePath,\n\t\t\ttableName: this.model.table,\n\t\t\tschemaName: this.model.schema,\n\t\t\tfileType: this.model.fileType\n\t\t});\n\n\t\tthis.model.proseDataPreview = null;\n\t\tif (response.dataPreview) {\n\t\t\tthis.model.proseDataPreview = response.dataPreview;\n\t\t}\n\n\t\tthis.model.proseColumns = [];\n\t\tthis.model.originalProseColumns = [];\n\t\tif (response.columnInfo) {\n\t\t\tresponse.columnInfo.forEach((column) => {\n\t\t\t\tthis.model.proseColumns.push({\n\t\t\t\t\tcolumnName: column.name,\n\t\t\t\t\tdataType: column.sqlType,\n\t\t\t\t\tprimaryKey: false,\n\t\t\t\t\tnullable: column.isNullable\n\t\t\t\t});\n\t\t\t\tthis.model.originalProseColumns.push({\n\t\t\t\t\tcolumnName: column.name,\n\t\t\t\t\tdataType: column.sqlType,\n\t\t\t\t\tprimaryKey: false,\n\t\t\t\t\tnullable: column.isNullable\n\t\t\t\t});\n\t\t\t});\n\t\t\treturn true;\n\t\t}\n\n\t\treturn false;\n\t}\n\n\tprivate async populateTable(tableData: string[][], columnHeaders: string[]) {\n\t\tlet rows;\n\t\tlet rowsLength = tableData.length;\n\n\t\tif (rowsLength > 50) {\n\t\t\trows = tableData;\n\t\t}\n\t\telse {\n\t\t\trows = tableData.slice(0, rowsLength);\n\t\t}\n\n\t\tthis.table.updateProperties({\n\t\t\tdata: rows,\n\t\t\tcolumns: columnHeaders,\n\t\t\theight: 400,\n\t\t\twidth: '700',\n\t\t});\n\t}\n}\n"]}